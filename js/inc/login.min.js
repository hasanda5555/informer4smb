(function(){window.addEventListener("pageshow",function(event){var historyTraversal=event.persisted||typeof window.performance!="undefined"&&window.performance.navigation.type===2;if(historyTraversal){window.location.reload()}});var previousContentPanel;var dataDialog;var isAdmin=true;$("[data-action]").click(function(e){e.preventDefault();var action=$(this).data("action");switch(action){case"changeContentPanel":var panelID=$(this).data("panel");if(panelID=="previous"){panelID=previousContentPanel?previousContentPanel:"login"}else{previousContentPanel=$(".content-panel").not(".hidden").attr("id")}$(".message").html("").addClass("hidden");$(".content-panel").not("#"+panelID).addClass("hidden");$("#"+panelID).removeClass("hidden");if(panelID=="help")$('[data-panel="help"]').addClass("hidden");else $('[data-panel="help"]').removeClass("hidden");break}});$("#btn-login").click(function(e){e.preventDefault();if($(this).hasClass("disabled"))return;var message="";$("#login .message").html("").addClass("hidden").removeClass("error");var username=$('#login input[name="userid"]').val();var pwd=$('#login input[name="passwd"]').val();if(username==""||pwd==""){message="You need to enter "+(username==""?"a username.":"your password.");$("#login .message").html(message).addClass("error").removeClass("hidden");return}$.ajax({method:"POST",url:"../user/user.php",data:{mode:"authenticate",userid:username,passwd:pwd}}).done(function(data){var xmlData=$.parseXML($.trim(data));var xml=$(xmlData);var result=xml.find("result").text();if(result=="ok"){var userid=xml.find("id").text();promptForData(userid)}else{message="Incorrect username or password.";$("#login .message").html(message).addClass("error").removeClass("hidden")}}).fail(function(){message="Failed to authenticate with the server.";$("#login .message").html(message).addClass("error").removeClass("hidden")})});function promptForData(userid){$(".data-dialog select").val("");$(".data-dialog option").not('.data-dialog option[value=""]').remove();$(".period-select-container").addClass("hidden");$.ajax({method:"POST",url:"../user/org.php",data:{mode:"getorgassigned",userid:userid}}).done(function(data){var xmlData=$.parseXML($.trim(data));var xml=$(xmlData);var result=xml.find("result").text();if(result=="ok"){var dialogContent=$(".data-dialog").clone();xml.find("org").each(function(index){var orgid=$(this).find("orgid").text();var orgname=$(this).find("orgname").text();$(".company-select",dialogContent).append('<option data-id="'+orgid+'" value="'+orgname+'">'+orgname+"</option>");if(index==0)$(".company-set .value",dialogContent).html(orgname)});if(xml.find("org").length==1){$(".company-set",dialogContent).removeClass("hidden");updateAvailablePeriods($(".company-set .value",dialogContent).text(),dialogContent)}else{$(".company-select-container",dialogContent).removeClass("hidden")}$(".company-select",dialogContent).change(function(e){var company=$(this).val();if(company!=""){updateAvailablePeriods(company)}else{$(".period-select-container",dialogContent).addClass("hidden");dataDialog.getButton("ok").disable()}});$(".period-select",dialogContent).change(function(e){var period=$(this).val();if(period!=""){dataDialog.getButton("ok").enable()}else{dataDialog.getButton("ok").disable()}});var dialogButtons=[{id:"ok",label:"OK",cssClass:"btn-primary",action:function(dialogRef){$(".company-select, .period-select",dialogContent).attr("disabled","disabled");dialogRef.getButton("ok").disable();dialogRef.getButton("admin").disable();var selectedCompany=$(".company-select option",dialogContent).length>2?$(".company-select",dialogContent).val():$(".company-value",dialogContent).text();var selectedPeriod=$(".period-select",dialogContent).val();$('#formLogin input[name="company"]').val(selectedCompany);$('#formLogin input[name="period"]').val(selectedPeriod);$("#formLogin").submit()}}];if(isAdmin){dialogButtons.push({id:"admin",label:"Admin",cssClass:"btn-link pull-left",action:function(dialogRef){$(".company-select, .period-select",dialogContent).attr("disabled","disabled");dialogRef.getButton("ok").disable();dialogRef.getButton("admin").disable();$('#formLogin input[name="company"]').remove();$('#formLogin input[name="period"]').remove();$("#formLogin").submit()}})}dataDialog=BootstrapDialog.show({title:"Select data source",message:dialogContent,cssClass:"period-dialog",type:BootstrapDialog.TYPE_PRIMARY,closable:false,width:"150px",onshow:function(dialog){dialog.getButton("ok").disable()},buttons:dialogButtons})}else{message="Unable to get company information.";$("#login .message").html(message).addClass("error").removeClass("hidden")}}).fail(function(){message="Failed to get company information.";$("#login .message").html(message).addClass("error").removeClass("hidden")})}function updateAvailablePeriods(company,context){if(!context)context=$(".modal-body");$(".period-select option",context).not('.period-select option[value=""]').remove();$.ajax({method:"POST",url:"../informer/reports.php",data:{mode:"monthyear",company:company}}).done(function(data){var xmlData=$.parseXML($.trim(data));var xml=$(xmlData);var result=xml.find("result").text();if(result=="ok"){var monthNames=["January","February","March","April","May","June","July","August","September","October","November","December"];xml.find("Value").each(function(index){var month=parseInt($(this).find("month").text());var year=$(this).find("year").text();$(".period-select",context).append('<option value="'+month+"|"+year+'">'+monthNames[month-1]+" "+year+"</option>");if(index==0)$(".period-set .value",context).html(monthNames[month-1]+" "+year)});if(xml.find("Value").length==1){$(".period-set",context).removeClass("hidden");dataDialog.getButton("ok").enable()}else{$(".period-select-container",context).removeClass("hidden")}}else{message="Unable to get period information.";$("#login .message").html(message).addClass("error").removeClass("hidden")}}).fail(function(){message="Failed to get period information.";$("#login .message").html(message).addClass("error").removeClass("hidden")})}$("#btn-reset").click(function(e){e.preventDefault();if($(this).hasClass("disabled"))return;var message="";$("#forget-password .message").html("").addClass("hidden").removeClass("error").removeClass("success");var username=$('#forget-password input[name="userid"]').val();if(username==""){message="You need to enter a username.";$("#forget-password .message").html(message).addClass("error").removeClass("hidden");return}$.ajax({method:"POST",url:"../user/user.php",data:{mode:"forgotpass",userid:username}}).done(function(data){var xmlData=$.parseXML($.trim(data));var xml=$(xmlData);var result=xml.find("result").text();var reason=xml.find("message").text();if(result=="ok"){message="Your password has been reset and emailed to you.";$("#forget-password .message").html(message).addClass("success").removeClass("hidden")}else{message="Unable to reset your password: "+reason;$("#forget-password .message").html(message).addClass("error").removeClass("hidden")}}).fail(function(){message="Failed to reset passowrd.";$("#forget-password .message").html(message).addClass("error").removeClass("hidden")})})})();